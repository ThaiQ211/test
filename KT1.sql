CREATE DATABASE KTL1_KHANG
GO
USE KTL1_KHANG
GO



CREATE TABLE KHACHHANG 
(
	MAKH NVARCHAR(10) NOT NULL ,
	TENKH NVARCHAR(20),
	DCHI NVARCHAR(20),
	DIENTHOAI NVARCHAR(20),
	PRIMARY KEY (MAKH)
)

CREATE TABLE MATHANG
(
	MAMH NVARCHAR(10) NOT NULL,
	TENMH NVARCHAR(20),
	DVT NVARCHAR(20),
	DONGIA INT ,
	PRIMARY KEY (MAMH)
)

CREATE TABLE DATHANG 
(
	MADH NVARCHAR(10) NOT NULL,
	NGAYDH DATE,
	NGAYGIAODK DATE,
	MAKH NVARCHAR(10),
	THANHTIEN INT ,
	TINHTRANG NVARCHAR(20),
	PRIMARY KEY (MADH),
	FOREIGN KEY (MAKH) REFERENCES KHACHHANG

)

CREATE TABLE CTDH 
(
	MADH NVARCHAR(10),
	MAMH NVARCHAR(10),
	SLDAT INT ,
	DGDAT INT,
	PRIMARY KEY (MADH, MAMH),
	FOREIGN KEY (MADH) REFERENCES DATHANG,
	FOREIGN KEY (MAMH) REFERENCES MATHANG,
)

--1.B
ALTER TABLE CTDH 
ADD CONSTRAINT CHK_SL CHECK(SLDAT >0 AND DGDAT >0)


ALTER TABLE KHACHHANG
ADD CONSTRAINT DF_TINHTRANG DEFAULT N'CHƯA XÁC ĐỊNH' FOR DIENTHOAI


ALTER TABLE DATHANG 
ADD CONSTRAINT CHK_TINHTRANG CHECK (TINHTRANG IN (N'CÒN HÀNG', N'HẾT HÀNG'))

ALTER TABLE MATHANG
ADD CONSTRAINT UNI_TRUNGTEN UNIQUE (TENMH) 




INSERT INTO KHACHHANG
VALUES
('KH001', N'LÊ VĂN A', N'10 LÊ TRỌNG TẤN', '00001111'),
('KH002', N'LÊ VĂN B', N'10 LÊ TRỌNG TẤN', '00017111'),
('KH003', N'LÊ VĂN C', N'10 LÊ TRỌNG TẤN', '00003111'),
('KH004', N'LÊ VĂN D', N'10 LÊ TRỌNG TẤN', '00001191'),
('KH005', N'LÊ VĂN E', N'10 LÊ TRỌNG TẤN', '00013141')


INSERT INTO MATHANG
VALUES
('MH001', 'KẸO', 'CÁI',1000),
('MH002', 'BÁNH', 'BỊCH',1000),
('MH003', 'COCA', 'CHAI',1000),
('MH004', 'NƯỚC', 'CHAI',1000),
('MH005', 'BÚT', 'CÁI',1000)


SET DATEFORMAT DMY
INSERT INTO DATHANG
VALUES
('DH001', '02/07/2022','03/07/2022', 'KH002', 9000, N'CÒN HÀNG'),
('DH002', '03/02/2022','03/07/2023', 'KH002', 9000, N'CÒN HÀNG'),
('DH003', '05/01/2022','03/07/2023', 'KH001', 9000, N'HẾT HÀNG'),
('DH004', '06/09/2022','03/07/2023', 'KH003', 9000, N'CÒN HÀNG'),
('DH005', '07/07/2022','03/07/2024', 'KH005', 9000, N'CÒN HÀNG')


INSERT INTO CTDH
VALUES
('DH001' , 'MH002', 9, 9000),
('DH002' , 'MH001', 6, 9000),
('DH003' , 'MH003', 5, 9000),
('DH003' , 'MH004', 3, 9000),
('DH004' , 'MH005', 1, 9000)





---CÂU 2
--A.
CREATE PROC TTDH1 @MADH NVARCHAR(10)
AS
BEGIN
	SELECT * FROM DATHANG WHERE MADH=@MADH
END

EXEC TTDH1 'DH001'


--B.
CREATE PROC TTDAT1 @MADH NVARCHAR(10)
AS
BEGIN
	SELECT NGAYDH, NGAYGIAODK,TENKH , THANHTIEN, TINHTRANG FROM DATHANG DH, KHACHHANG KH WHERE MADH= @MADH AND DH.MAKH= KH.MAKH
END

EXEC TTDAT1 'DH001'

--CÂU 3
--A.
CREATE FUNCTION TTDONHANG (@MADH NVARCHAR(10))
RETURNS TABLE 
AS 
	RETURN (
	SELECT MH.MAMH, TENMH , SLDAT, DGDAT , (SLDAT*DGDAT) AS THANHTIEN
	FROM MATHANG MH, CTDH CT
	WHERE MH.MAMH= CT.MAMH AND MADH=@MADH

	)

SELECT*FROM TTDONHANG('DH001');

--B.
CREATE FUNCTION TONGTHANHTIEN (@MAKH NVARCHAR(10))
RETURNS INT
AS
BEGIN
	DECLARE @tong INT 
	SET @tong = ( SELECT SUM(THANHTIEN ) FROM DATHANG WHERE MAKH= @MAKH)
	RETURN @TONG
END
GO
DECLARE @T INT, @MKH NVARCHAR(10) = 'KH001'
SET @T= DBO.TONGTHANHTIEN(@MKH)
PRINT @T

--C.
CREATE FUNCTION TONGDHNGAY (@NGAY DATE)
RETURNS INT
AS
BEGIN 
	DECLARE @TONG INT
	SET @TONG = (SELECT COUNT(MADH) FROM DATHANG WHERE NGAYDH=@NGAY)
	RETURN @TONG

END
GO

DECLARE @TONGD INT , @NG DATE= '03/02/2022'
SET @TONGD = DBO.TONGDHNGAY(@NG)
PRINT @TONGD


--CÂU 4 
--A.
CREATE TRIGGER KTNGAYDH ON DATHANG 
FOR INSERT, UPDATE, DELETE
AS
BEGIN
	IF EXISTS ( SELECT *  FROM INSERTED WHERE DAY(NGAYDH) < GETDATE())
	BEGIN 
		PRINT 'NGÀY ĐẶT HÀNG KHÔNG ĐƯỢC NHỎ HƠN NGÀY HIỆN TẠI'
		ROLLBACK TRAN
	END
END

INSERT INTO DATHANG VALUES ('DH006', '02/07/2022','03/07/2022', 'KH002', 9000, N'CÒN HÀNG')

--B.

CREATE TRIGGER trg_instead_of_insert
ON v_KhachHang_MatHang
INSTEAD OF INSERT
AS
BEGIN
    -- Biến kiểm tra tồn tại
    DECLARE @ExistsKH INT, @ExistsMH INT;
    
    -- Lấy dữ liệu từ bản ghi đang được chèn
    DECLARE @MAKH INT, @MAMH INT, @TENKH NVARCHAR(100), @TENMH NVARCHAR(100);
    
    SELECT @MAKH = inserted.MAKH, 
           @MAMH = inserted.MAMH,
           @TENKH = inserted.TENKH,
           @TENMH = inserted.TENMH
    FROM inserted;

    -- Kiểm tra xem MAKH đã tồn tại chưa
    SELECT @ExistsKH = COUNT(*) 
    FROM KHACHHANG 
    WHERE MAKH = @MAKH;

    -- Kiểm tra xem MAMH đã tồn tại chưa
    SELECT @ExistsMH = COUNT(*)
    FROM MATHANG 
    WHERE MAMH = @MAMH;

    -- Nếu MAKH hoặc MAMH đã tồn tại, báo lỗi
    IF (@ExistsKH > 0 OR @ExistsMH > 0)
    BEGIN
        RAISERROR ('Dữ liệu đã tồn tại trong hệ thống.', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END

    -- Nếu không tồn tại thì thêm dữ liệu vào bảng KHACHHANG và MATHANG
    INSERT INTO KHACHHANG(MAKH, TENKH)
    VALUES (@MAKH, @TENKH);

    INSERT INTO MATHANG(MAMH, TENMH)
    VALUES (@MAMH, @TENMH);
END































